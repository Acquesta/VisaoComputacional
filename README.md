Guia: Deploy de Aplicação de Visão Computacional com GPU no Google Cloud via GitHubEste guia detalha o processo para implantar sua aplicação Python (Flask/SocketIO + YOLOv8) em uma Máquina Virtual (VM) do Google Compute Engine (GCE) com uma GPU, utilizando o GitHub para versionamento e o Google Cloud Build para automação de build.Pré-requisitosConta no Google Cloud: Você precisa de uma conta no GCP com um projeto criado e o faturamento ativado.Conta no GitHub: Um repositório para hospedar seu código.gcloud CLI: A ferramenta de linha de comando do Google Cloud instalada e configurada na sua máquina local.Docker: O Docker Desktop instalado em sua máquina local para testes.Passo 1: Preparando o Código e o GitHubEstrutura do Projeto: Organize seu projeto no repositório GitHub com a seguinte estrutura:/
|-- models/
|   |-- yolov8n.pt
|-- app.py
|-- requirements.txt
|-- Dockerfile
|-- cloudbuild.yaml
|-- README.md
Arquivos de Configuração: Adicione os arquivos requirements.txt, Dockerfile e cloudbuild.yaml (fornecidos nesta resposta) ao seu repositório.Commit e Push: Envie todos os arquivos para o seu repositório no GitHub.Passo 2: Configurando o Google Cloud Platform (GCP)Ativar APIs: No seu projeto GCP, ative as seguintes APIs:Compute Engine API (para criar a VM)Cloud Build API (para automatizar o build)Container Registry API (para armazenar a imagem Docker)Solicitar Quota de GPU: Este é um passo crucial. Por padrão, as contas novas não têm permissão para criar VMs com GPU.Vá para IAM e Admin > Cotas.Filtre pela métrica GPUs (all regions) ou pelo nome da GPU que deseja, como NVIDIA T4 GPUs.Selecione a cota e clique em "EDITAR COTAS".Preencha o formulário solicitando um aumento do limite para 1 na região que você pretende usar (ex: us-central1). A aprovação pode levar algumas horas ou dias.Passo 3: Criando a Máquina Virtual com GPUAcesse o Compute Engine: Vá para Compute Engine > Instâncias de VM e clique em "CRIAR INSTÂNCIA".Configuração da VM:Nome: Dê um nome para sua VM (ex: vm-yolo-gpu).Região e Zona: Escolha a mesma região onde você solicitou a quota de GPU.Configuração da Máquina:Série: N1 (ou outra compatível com GPU).Tipo de Máquina: n1-standard-4 (4 vCPUs, 15 GB de memória) é um bom ponto de partida.GPUs:Clique em "ADICIONAR GPU".Tipo de GPU: Selecione o modelo que teve a quota aprovada (ex: NVIDIA Tesla T4).Número de GPUs: 1.Marque a caixa: "Instalar o driver da GPU NVIDIA automaticamente na primeira inicialização".Disco de Inicialização:Clique em "Alterar".Sistema Operacional: Deep Learning on Linux.Versão: Escolha uma imagem como Deep Learning VM com CUDA 11.8 M114 (ou a mais recente disponível). Isso já instala Docker, CUDA e os drivers NVIDIA.Firewall: Marque Permitir tráfego HTTP e Permitir tráfego HTTPS.Crie a Instância: Clique em "Criar". A VM levará alguns minutos para iniciar e instalar os drivers.Regra de Firewall Adicional: Sua aplicação roda na porta 5000. Crie uma regra de firewall para permitir o acesso:Vá para Rede VPC > Firewall.Clique em "CRIAR REGRA DE FIREWALL".Nome: allow-port-5000.Destinos: Todas as instâncias na rede.Filtro de origem: Intervalos IPv4 > 0.0.0.0/0 (para permitir acesso de qualquer lugar).Protocolos e portas: Marque TCP e insira 5000.Clique em "Criar".Passo 4: Deploy (Opção Manual e Automatizada)Opção A: Deploy Manual (Recomendado para a primeira vez)Este método ajuda a entender o processo antes de automatizá-lo.Conecte-se à VM: Use o botão "SSH" na lista de instâncias de VM no console do GCP para abrir um terminal.Clone o Repositório: No terminal da VM, clone seu projeto:git clone [https://github.com/seu-usuario/seu-repositorio.git](https://github.com/seu-usuario/seu-repositorio.git)
cd seu-repositorio
Autentique o Docker: Configure o Docker para poder baixar imagens do GCR do seu projeto:gcloud auth configure-docker
Construa e Execute o Container:Build:docker build -t gcr.io/SEU_PROJECT_ID/sua-app-visao:latest .
(Substitua SEU_PROJECT_ID pelo ID do seu projeto GCP).Run: O flag --gpus all é o que permite o container acessar a GPU da VM.docker run -d -p 5000:5000 --gpus all --restart always --name yolo-app gcr.io/SEU_PROJECT_ID/sua-app-visao:latest
Sua aplicação estará rodando no IP externo da VM, na porta 5000.Opção B: Deploy Automatizado com Cloud BuildConecte o GitHub ao Cloud Build:Vá para Cloud Build > Gatilhos.Clique em "CONECTAR REPOSITÓRIO".Selecione GitHub, autentique e escolha seu repositório.Crie o Gatilho (Trigger):Nome: Dê um nome ao seu gatilho.Evento: Enviar por push para uma ramificação.Ramificação: ^main$ (para acionar a cada push na branch main).Configuração: Arquivo de configuração do Cloud Build (yaml ou json).Localização: Repositório. Deixe o caminho padrão (/cloudbuild.yaml).Clique em "Criar".Processo de Deploy:Agora, a cada git push na sua branch main, o Cloud Build irá automaticamente construir a imagem Docker e enviá-la para o GCR.Para atualizar a aplicação na VM, você ainda precisará se conectar via SSH e executar os seguintes comandos:# Para o container antigo
docker stop yolo-app
docker rm yolo-app

# Puxa a nova imagem (que o Cloud Build marcou como 'latest')
docker pull gcr.io/SEU_PROJECT_ID/sua-app-visao:latest

# Executa o novo container
docker run -d -p 5000:5000 --gpus all --restart always --name yolo-app gcr.io/SEU_PROJECT_ID/sua-app-visao:latest
Nota: A automação completa do deploy na VM (o último passo) pode ser feita com scripts mais avançados no cloudbuild.yaml que executam comandos remotos via SSH, mas a abordagem acima é um excelente ponto de partida.